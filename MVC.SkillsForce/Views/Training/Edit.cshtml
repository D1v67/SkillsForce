@model Common.SkillsForce.ViewModel.TrainingViewModel

@{
    ViewBag.Title = "Create Training";

}


<style>
    label {
        font-weight: bold;
        font-size: 16px; 
    }
</style>

<script src="~/Scripts/jquery-3.7.1.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js" integrity="sha512-VEd+nq25CkR676O+pLBnDW09R7VQX9Mdiij052gVCp5yVH3jGtH70Ho/UUv4mJDsEdTvqRCFZg0NKGiojGnUCw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script type="text/javascript" src="
    https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
@*
    https://codeseven.github.io/toastr/*@
<script type="text/javascript" src="
    https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
<link rel="stylesheet" href="
    https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css">


<body style="background-color: #c6c6c6;">

    <div class="container">
        <div class="card mx-auto mt-5" style="max-width: 600px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
            <div class="card-body">
                <div class="bg-primary text-white p-3 mb-3 rounded">
                    <h2 class="card-title text-center mb-0">Edit Training</h2>
                </div>
                <h2 class="card-title text-center mb-4">Edit the Training below</h2>

                <div id="registrationSuccessDiv" style="display: none;">
                    <div class="alert alert-success" role="alert">
                        Training Edited successfully
                    </div>
                </div>

                <form id="trainingForm" class="needs-validation" novalidate>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="TrainingName" class="form-label">Training Name</label>
                                <input type="text" class="form-control" id="TrainingName" required>
                                <div class="invalid-feedback">
                                    Please enter the Training Name
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="TrainingDescription" class="form-label">Training Description</label>
                                <textarea class="form-control" id="TrainingDescription" required></textarea>
                                <div class="invalid-feedback">
                                    Please enter the Training Description
                                </div>
                            </div>



                            <div class="mb-3">
                                <label for="DepartmentID">Select Department:</label>
                                <select class="form-control form-select" id="DepartmentID" name="DepartmentID" required>
                                    <option value="" selected disabled>Select Department</option>
                                    <!-- Options will be populated using AJAX -->
                                </select>
                                <div class="invalid-feedback">
                                    Please select the Department
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="Prerequisites">Select Prerequisites:</label>
                                <select class="form-control form-select" id="Prerequisites" name="Prerequisites">
                                    <option value="" selected disabled>Select Prerequisites</option>
                                    <!-- Options will be populated using AJAX -->
                                </select>
                                @*<div class="invalid-feedback">
                                        Please select at least one Prerequisite
                                    </div>*@
                            </div>



                        </div>

                        <div class="col-md-6">

                            <div class="mb-3">
                                <label for="StartDate" class="form-label">Start Date (mm/dd/yyyy)</label>
                                <input type="date" class="form-control" id="StartDate" required>
                                <div class="invalid-feedback">
                                    Please enter the Start Date
                                </div>
                            </div>


                            <div class="mb-3">
                                <label for="RegistrationDeadline" class="form-label">Registration Deadline (mm/dd/yyyy)</label>
                                <input type="date" class="form-control" id="RegistrationDeadline" required>
                                <div class="invalid-feedback">
                                    Please enter the Registration Deadline
                                </div>
                            </div>


                            <div class="mb-3">
                                <label for="Capacity" class="form-label">Capacity</label>
                                <input type="text" class="form-control" id="Capacity" required>
                                <div class="invalid-feedback">
                                    Please enter the Capacity
                                </div>
                            </div>



                        </div>
                    </div>

                    <!-- Table to display selected prerequisites -->
                    <!-- Table to display selected prerequisites -->
                    <div id="selectedPrerequisitesDiv" style="display: none; text-align: center;">
                        <h4>Selected Prerequisites</h4>


                        <!-- Delayed display of the spinner -->
                        <!-- Centered and larger spinner-border -->
                        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                            <span class="visually-hidden">Loading...</span>
                        </div>

                        <!-- Centered and larger spinner-grow -->
                        <div class="spinner-grow text-primary" role="status" style="width: 3rem; height: 3rem;">
                            <span class="visually-hidden">Loading...</span>
                        </div>

                        <table class="table" id="selectedPrerequisitesTable">
                            <thead>
                                <tr>
                                    <th>Prerequisite ID</th>
                                    <th>Prerequisite Name</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Selected prerequisites will be displayed here -->
                            </tbody>
                        </table>
                    </div>


                    <div class="row mt-3">
                        <div class="col-md-6">
                            <!-- Back button -->
                            <a href="@Url.Action("Index", "Training")" class="btn btn-danger">Back</a>
                        </div>
                        <div class="col-md-6 text-right">
                            <!-- Save button -->
                            <button type="submit" class="btn btn-primary" id="btnRegister">Save</button>
                        </div>
                    </div>


                </form>
            </div>
        </div>
    </div>
</body>


<script>
    // Function to set the minimum date for date inputs to today
    function setMinDate() {
        var today = new Date().toISOString().split('T')[0];
        document.getElementById('StartDate').min = today;
        document.getElementById('RegistrationDeadline').min = today;
        console.log('date')
    }

    // Execute the function when the page is loaded
    window.onload = setMinDate;


</script>


<script>
    $(document).ready(function () {

      var trainingID = '@Model.TrainingID';
        // Validate Training Name on blur
        // Function to set the minimum date for date inputs to today
        function setMinDate() {
            var today = new Date().toISOString().split('T')[0];
            document.getElementById('StartDate').min = today;
            document.getElementById('RegistrationDeadline').min = today;
            console.log('date');
        }

        // Execute the function when the page is loaded
        window.onload = setMinDate;


        toastr.options.timeOut = 3000;
        function validateFieldOnBlur(field, regex) {
            var value = field.val();
            if (!regex.test(value)) {
                field.addClass('is-invalid');
                var fieldName = field.attr('id');
                toastr.error("Invalid input for " + fieldName + ". Please check again.");
            } else {
                field.removeClass('is-invalid');
            }
        }

        // Validate Training Name on blur
        $('#TrainingName').blur(function () {
            validateFieldOnBlur($(this), /^[A-Z][a-z]*( [A-Z][a-z]*)*$/);
        });

        // Validate Capacity on blur
        $('#Capacity').blur(function () {
            validateFieldOnBlur($(this), /^[1-9][0-9]*$/);
        });

        function validateStartDateVsRegistrationDeadline() {
            var startDate = new Date($('#StartDate').val());
            var registrationDeadline = new Date($('#RegistrationDeadline').val());

            if (startDate <= registrationDeadline) {
                $('#StartDate').addClass('is-invalid');
                $('#RegistrationDeadline').addClass('is-invalid');
                toastr.error("Start date must be greater than registration deadline.");
                return false;
            } else {
                $('#StartDate').removeClass('is-invalid');
                $('#RegistrationDeadline').removeClass('is-invalid');
                return true;
            }
        }

        // Validate Start Date vs Registration Deadline
        $('#StartDate, #RegistrationDeadline').change(function () {
            validateStartDateVsRegistrationDeadline();
        });





        // Fetch training details using AJAX
        $.ajax({
            url: '/Training/GetTrainingDetails/' + '@Model.TrainingID',
            type: 'GET',
            success: function (trainingData) {

                var registrationDeadline = convertDateFormat(trainingData.RegistrationDeadline);
                var startDate = convertDateFormat(trainingData.StartDate);



                $('#TrainingName').val(trainingData.TrainingName);
                $('#TrainingDescription').val(trainingData.TrainingDescription);
                $('#StartDate').val(startDate);
                $('#RegistrationDeadline').val(registrationDeadline);
                $('#Capacity').val(trainingData.Capacity);
                $('#DepartmentID').val(trainingData.DepartmentID);

                console.log('data date' + trainingData.RegistrationDeadline)

                $.ajax({
                    url: '/Department/GetListOfDepartments', // Replace with your actual endpoint for departments
                    type: 'GET',
                    success: function (departmentsData) {
                        var departmentDropdown = $('#DepartmentID');
                        departmentDropdown.empty();
                        $.each(departmentsData, function (index, item) {
                            departmentDropdown.append($('<option>', {
                                value: item.DepartmentID,
                                text: item.DepartmentName,
                                selected: (item.DepartmentID === trainingData.DepartmentID)
                            }));
                        });
                    },
                    error: function (error) {
                        console.log(error);
                    }
                });

                // Show the spinner before fetching prerequisites
                $('#selectedPrerequisitesDiv .spinner-border, #selectedPrerequisitesDiv .spinner-grow').show();


                // Fetch Prerequisites
                $.ajax({
                    url: '/Prerequisite/GetListOfPrerequisites', // Replace with your actual endpoint for prerequisites
                    type: 'GET',
                    success: function (prerequisitesData) {
                        var prerequisitesDropdown = $('#Prerequisites');
                        prerequisitesDropdown.empty();
                        prerequisitesDropdown.append('<option value="" selected disabled>Select Prerequisite</option>');


                        $.each(prerequisitesData, function (index, item) {
                            prerequisitesDropdown.append($('<option>', {
                                value: item.PrerequisiteID,
                                text: item.PrerequisiteName
                            }));
                        });

                        // Set the selected prerequisites
                        $.each(trainingData.Prerequisites, function (index, selectedPrerequisite) {
                            prerequisitesDropdown.append($('<option>', {
                                value: selectedPrerequisite.PrerequisiteID,
                                text: selectedPrerequisite.PrerequisiteName,
                                selected: true
                            }));


                            var tableBody = $('#selectedPrerequisitesTable tbody');
                            tableBody.append('<tr><td>' + selectedPrerequisite.PrerequisiteID +
                                '</td><td>' + selectedPrerequisite.PrerequisiteName +
                                '</td><td><button class="btn btn-danger btn-sm deleteRow">Delete</button></td></tr>');
                        });

                        // Hide the spinner after prerequisites are fetched
                       // //
                       //setTimeout(
                       //     () => {
                              

                       //     },300
                       // )
                        $('#selectedPrerequisitesDiv .spinner-border, #selectedPrerequisitesDiv .spinner-grow').hide();
                        $('#selectedPrerequisitesDiv').show();

                        
                    },
                    error: function (error) {
                        console.log(error);
                    }
                });
            },
            error: function (error) {
                console.log(error);
            }
        });

        $('#Prerequisites').change(function () {
            var selectedPrerequisiteID = $('#Prerequisites option:selected').val();
            var selectedPrerequisiteName = $('#Prerequisites option:selected').text();
            var tableBody = $('#selectedPrerequisitesTable tbody');
            var divSelectedPrerequisites = $('#selectedPrerequisitesDiv');

            // Add a delete button to each row
            tableBody.append('<tr><td>' + selectedPrerequisiteID + '</td><td>' + selectedPrerequisiteName +
                '</td><td><button class="btn btn-danger btn-sm deleteRow">Delete</button></td></tr>');

            // Show the div when a prerequisite is added
            divSelectedPrerequisites.show();
        });

        $('#selectedPrerequisitesTable').on('click', '.deleteRow', function () {
            $(this).closest('tr').remove();
        });

       $("#trainingForm").submit(function (event) {
                event.preventDefault();

                // Validate form fields
           if (!validateForm() || !validateStartDateVsRegistrationDeadline()) {
               return;
           }


           if ($('#trainingForm .is-invalid').length > 0) {
               $('#trainingForm .is-invalid').each(function () {
                   var fieldName = $(this).siblings('label').text().trim();
                   toastr.error("Invalid input for " + fieldName + ". Please check again.");

                   //$(this).siblings('.help-block').show();
               });
               return;
           }

                var selectedPrerequisites = [];
                $('#selectedPrerequisitesTable tbody tr').each(function () {
                    var prerequisiteID = parseInt($(this).find('td:first').text());
                    var prerequisiteName = $(this).find('td:nth-child(2)').text();
                    selectedPrerequisites.push({ PrerequisiteID: prerequisiteID, PrerequisiteName: prerequisiteName });
                });

                var formData = {
                    TrainingID: parseInt('@Model.TrainingID'),
                    TrainingName: $('#TrainingName').val(),
                    TrainingDescription: $('#TrainingDescription').val(),
                    RegistrationDeadline: $('#RegistrationDeadline').val(),
                    StartDate: $('#StartDate').val(),
                    Capacity: $('#Capacity').val(),
                    DepartmentID: parseInt($("#DepartmentID").val()),
                    Prerequisites: selectedPrerequisites
                };

                console.log(formData)
               
                $.ajax({
                    type: "POST",
                    url: "/Training/Edit",
                    data: formData,
                    success: function (response) {
                        console.log(response);
                        if (response.url) {
                            console.log('iin success')
                            // Redirect to a relevant page on success
                            setTimeout(function () {
                                window.location = response.url;
                            }, 500);
                            $("#registrationSuccessDiv").show();
                        } else {
                            console.log(response.errorMessage);

                            handleValidationErrors(response.errorMessage);
                        }
                    },
                    error: function (error) {
                        console.error("Error submitting form:", error);
                  
                    }
        });
     });


        function handleValidationErrors(errors) {
       
            $('.is-invalid').removeClass('is-invalid');


            errors.forEach(function (error) {
                toastr.error(error);
                $('#' + error.field).addClass('is-invalid');
                console.log(error.field)
            });
        }

        function validateForm() {
            var form = document.getElementById('trainingForm');
            if (form.checkValidity() === false) {
                event.preventDefault();
                event.stopPropagation();
                form.classList.add('was-validated');
                return false;
            }
            return true;

        }

        function convertDateFormat(inputDate) {
            var parts = inputDate.split('/');
            return parts[2] + '-' + parts[0].padStart(2, '0') + '-' + parts[1].padStart(2, '0');
        }


    });
</script>